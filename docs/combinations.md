<!--
GENERATED FILE - DO NOT EDIT
This file was generated by [MarkdownSnippets](https://github.com/SimonCropp/MarkdownSnippets).
Source File: /docs/mdsource/combinations.source.md
To change this file edit the source file and then run MarkdownSnippets.
-->

# VerifyCombinations

VerifyCombinations allows all combinations of the given input lists to be executed, and the results all written to one file.


## Method being tested

<!-- snippet: CombinationTargetMethod -->
<a id='snippet-CombinationTargetMethod'></a>
```cs
public static string BuildAddress(int streetNumber, string street, string city)
{
    ArgumentException.ThrowIfNullOrWhiteSpace(street);
    ArgumentException.ThrowIfNullOrWhiteSpace(city);
    ArgumentOutOfRangeException.ThrowIfLessThan(streetNumber, 1);

    return $"{streetNumber} {street}, {city}";
}
```
<sup><a href='/src/Verify.Tests/VerifyCombinationsSample.cs#L6-L17' title='Snippet source file'>snippet source</a> | <a href='#snippet-CombinationTargetMethod' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Test

<!-- snippet: CombinationSample -->
<a id='snippet-CombinationSample'></a>
```cs
[Fact]
public Task BuildAddressTest()
{
    int[] streetNumbers = [1, 10];
    string[] streets = ["Smith St", "Wallace St"];
    string[] cities = ["Sydney", "Chicago"];
    return VerifyCombinations(
        BuildAddress,
        streetNumbers,
        streets,
        cities);
}
```
<sup><a href='/src/Verify.Tests/VerifyCombinationsSample.cs#L19-L34' title='Snippet source file'>snippet source</a> | <a href='#snippet-CombinationSample' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Result

<!-- snippet: VerifyCombinationsSample.BuildAddressTest.verified.txt -->
<a id='snippet-VerifyCombinationsSample.BuildAddressTest.verified.txt'></a>
```txt
{
   1, Smith St  , Sydney : 1 Smith St, Sydney,
   1, Smith St  , Chicago: 1 Smith St, Chicago,
   1, Wallace St, Sydney : 1 Wallace St, Sydney,
   1, Wallace St, Chicago: 1 Wallace St, Chicago,
  10, Smith St  , Sydney : 10 Smith St, Sydney,
  10, Smith St  , Chicago: 10 Smith St, Chicago,
  10, Wallace St, Sydney : 10 Wallace St, Sydney,
  10, Wallace St, Chicago: 10 Wallace St, Chicago
}
```
<sup><a href='/src/Verify.Tests/VerifyCombinationsSample.BuildAddressTest.verified.txt#L1-L10' title='Snippet source file'>snippet source</a> | <a href='#snippet-VerifyCombinationsSample.BuildAddressTest.verified.txt' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Column Alignment

Key value are aligned based on type.

 * Numbers (int, double, float etc) are aligned right
 * All other types are aligned left


## CaptureExceptions

By default exceptions are not captured.

To enable exception capture use `captureExceptions = true`:

<!-- snippet: CombinationSample_CaptureExceptions -->
<a id='snippet-CombinationSample_CaptureExceptions'></a>
```cs
[Fact]
public Task BuildAddressExceptionsTest()
{
    int[] streetNumbers = [-1, 0, 10];
    string[] streets = [null!, "", " ", "Valid St"];
    string[] cities = [null!, "", " ", "Valid City"];
    return VerifyCombinations(
        BuildAddress,
        streetNumbers,
        streets,
        cities,
        captureExceptions: true);
}
```
<sup><a href='/src/Verify.Tests/VerifyCombinationsSample.cs#L53-L69' title='Snippet source file'>snippet source</a> | <a href='#snippet-CombinationSample_CaptureExceptions' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


### Result

<!-- snippet: VerifyCombinationsSample.BuildAddressExceptionsTest.verified.txt -->
<a id='snippet-VerifyCombinationsSample.BuildAddressExceptionsTest.verified.txt'></a>
```txt
{
  -1, null    , null      : ArgumentNullException: Value cannot be null. (Parameter 'street'),
  -1, null    ,           : ArgumentNullException: Value cannot be null. (Parameter 'street'),
  -1, null    ,           : ArgumentNullException: Value cannot be null. (Parameter 'street'),
  -1, null    , Valid City: ArgumentNullException: Value cannot be null. (Parameter 'street'),
  -1,         , null      : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
  -1,         ,           : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
  -1,         ,           : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
  -1,         , Valid City: ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
  -1,         , null      : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
  -1,         ,           : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
  -1,         ,           : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
  -1,         , Valid City: ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
  -1, Valid St, null      : ArgumentNullException: Value cannot be null. (Parameter 'city'),
  -1, Valid St,           : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'city'),
  -1, Valid St,           : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'city'),
  -1, Valid St, Valid City:
ArgumentOutOfRangeException: streetNumber ('-1') must be greater than or equal to '1'. (Parameter 'streetNumber')
Actual value was -1.,
   0, null    , null      : ArgumentNullException: Value cannot be null. (Parameter 'street'),
   0, null    ,           : ArgumentNullException: Value cannot be null. (Parameter 'street'),
   0, null    ,           : ArgumentNullException: Value cannot be null. (Parameter 'street'),
   0, null    , Valid City: ArgumentNullException: Value cannot be null. (Parameter 'street'),
   0,         , null      : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
   0,         ,           : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
   0,         ,           : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
   0,         , Valid City: ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
   0,         , null      : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
   0,         ,           : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
   0,         ,           : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
   0,         , Valid City: ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
   0, Valid St, null      : ArgumentNullException: Value cannot be null. (Parameter 'city'),
   0, Valid St,           : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'city'),
   0, Valid St,           : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'city'),
   0, Valid St, Valid City:
ArgumentOutOfRangeException: streetNumber ('0') must be greater than or equal to '1'. (Parameter 'streetNumber')
Actual value was 0.,
  10, null    , null      : ArgumentNullException: Value cannot be null. (Parameter 'street'),
  10, null    ,           : ArgumentNullException: Value cannot be null. (Parameter 'street'),
  10, null    ,           : ArgumentNullException: Value cannot be null. (Parameter 'street'),
  10, null    , Valid City: ArgumentNullException: Value cannot be null. (Parameter 'street'),
  10,         , null      : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
  10,         ,           : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
  10,         ,           : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
  10,         , Valid City: ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
  10,         , null      : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
  10,         ,           : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
  10,         ,           : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
  10,         , Valid City: ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'street'),
  10, Valid St, null      : ArgumentNullException: Value cannot be null. (Parameter 'city'),
  10, Valid St,           : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'city'),
  10, Valid St,           : ArgumentException: The value cannot be an empty string or composed entirely of whitespace. (Parameter 'city'),
  10, Valid St, Valid City: 10 Valid St, Valid City
}
```
<sup><a href='/src/Verify.Tests/VerifyCombinationsSample.BuildAddressExceptionsTest.verified.txt#L1-L54' title='Snippet source file'>snippet source</a> | <a href='#snippet-VerifyCombinationsSample.BuildAddressExceptionsTest.verified.txt' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


### Global CaptureExceptions

Exception capture can be enable globally:

<!-- snippet: GlobalCaptureExceptions -->
<a id='snippet-GlobalCaptureExceptions'></a>
```cs
[ModuleInitializer]
public static void Initialize() =>
    VerifyCombinationSettings.CaptureExceptions();
```
<sup><a href='/src/StaticSettingsTests/VerifyCombinationsTests.cs#L4-L10' title='Snippet source file'>snippet source</a> | <a href='#snippet-GlobalCaptureExceptions' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

If exception capture has been enabled globally, it can be disable at the method test level using `captureExceptions: false`.

<!-- snippet: CombinationSample_CaptureExceptionsFalse -->
<a id='snippet-CombinationSample_CaptureExceptionsFalse'></a>
```cs
[Fact]
public Task BuildAddressExceptionsDisabledTest()
{
    int[] streetNumbers = [1, 10];
    string[] streets = ["Smith St", "Wallace St"];
    string[] cities = ["Sydney", "Chicago"];
    return VerifyCombinations(
        BuildAddress,
        streetNumbers,
        streets,
        cities,
        captureExceptions: false);
}
```
<sup><a href='/src/StaticSettingsTests/VerifyCombinationsTests.cs#L69-L85' title='Snippet source file'>snippet source</a> | <a href='#snippet-CombinationSample_CaptureExceptionsFalse' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


## Result serialization

Serialization of results is done using `CombinationResultsConverter`

<!-- snippet: CombinationResultsConverter.cs -->
<a id='snippet-CombinationResultsConverter.cs'></a>
```cs
namespace VerifyTests;

public class CombinationResultsConverter :
    WriteOnlyJsonConverter<CombinationResults>
{
    public override void Write(VerifyJsonWriter writer, CombinationResults results)
    {
        writer.WriteStartObject();

        var items = results.Items;
        if (items.Count == 0)
        {
            return;
        }

        var keysLength = items[0].Keys.Count;

        var maxKeyLengths = new int[keysLength];
        var keyValues = new string[items.Count, keysLength];

        for (var itemIndex = 0; itemIndex < items.Count; itemIndex++)
        {
            var item = items[itemIndex];
            for (var keyIndex = 0; keyIndex < keysLength; keyIndex++)
            {
                var key = item.Keys[keyIndex];
                var name = VerifierSettings.GetNameForParameter(key, pathFriendly: false);
                keyValues[itemIndex, keyIndex] = name;
                var currentKeyLength = maxKeyLengths[keyIndex];
                if (name.Length > currentKeyLength)
                {
                    maxKeyLengths[keyIndex] = name.Length;
                }
            }
        }

        var keys = new CombinationKey[keysLength];
        for (var itemIndex = 0; itemIndex < items.Count; itemIndex++)
        {
            for (var keyIndex = 0; keyIndex < keysLength; keyIndex++)
            {
                keys[keyIndex] = new(
                    Value: keyValues[itemIndex, keyIndex],
                    MaxLength: maxKeyLengths[keyIndex],
                    Type: results.KeyTypes?[keyIndex]);
            }

            var item = items[itemIndex];
            var name = BuildPropertyName(keys);
            writer.WritePropertyName(name);
            WriteValue(writer, item);
        }

        writer.WriteEndObject();
    }

    protected virtual string BuildPropertyName(IReadOnlyList<CombinationKey> keys)
    {
        var builder = new StringBuilder();
        foreach (var (value, maxLength, type) in keys)
        {
            var padding = maxLength - value.Length;
            if (type != null &&
                type.IsNumeric())
            {
                builder.Append(' ', padding);
                builder.Append(value);
            }
            else
            {
                builder.Append(value);
                builder.Append(' ', padding);
            }

            builder.Append(", ");
        }

        builder.Length -= 2;
        return builder.ToString();
    }

    protected virtual void WriteValue(VerifyJsonWriter writer, CombinationResult result)
    {
        var exception = result.Exception;
        if (exception == null)
        {
            writer.WriteValue(result.Value);
            return;
        }

        writer.WriteValue($"{exception.GetType().Name}: {exception.Message}");
    }
}
```
<sup><a href='/src/Verify/Combinations/CombinationResultsConverter.cs#L1-L93' title='Snippet source file'>snippet source</a> | <a href='#snippet-CombinationResultsConverter.cs' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


### Custom

Combination serialization can be customized using a Converter.


#### Converter

Inherit from `CombinationResultsConverter` and override the desired members.

The below sample override `BuildPropertyName` to customize the property name. It bypasses the default implementation and hence does not pad columns or use VerifierSettings.GetNameForParameter for key conversion.

<!-- snippet: CombinationSample_CustomSerializationConverter -->
<a id='snippet-CombinationSample_CustomSerializationConverter'></a>
```cs
class CustomCombinationConverter :
    CombinationResultsConverter
{

    protected override string BuildPropertyName(IReadOnlyList<CombinationKey> keys) =>
        string.Join(", ", keys.Select(_ => _.Value));
}
```
<sup><a href='/src/StaticSettingsTests/VerifyCombinationsTests.cs#L114-L124' title='Snippet source file'>snippet source</a> | <a href='#snippet-CombinationSample_CustomSerializationConverter' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

Full control of serialization can be achieved by inheriting from `WriteOnlyJsonConverter<CombinationResults>`.


#### Insert Converter

Insert the new converter at the top of the converter stack.

<!-- snippet: CombinationSample_CustomSerializationModuleInitializer -->
<a id='snippet-CombinationSample_CustomSerializationModuleInitializer'></a>
```cs
static CustomCombinationConverter customConverter = new();

[ModuleInitializer]
public static void Init() =>
    VerifierSettings.AddExtraSettings(_ => _.Converters.Insert(0, customConverter));
```
<sup><a href='/src/StaticSettingsTests/VerifyCombinationsTests.cs#L87-L95' title='Snippet source file'>snippet source</a> | <a href='#snippet-CombinationSample_CustomSerializationModuleInitializer' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->


#### Result

<!-- snippet: VerifyCombinationsTests.Combination_CustomSerialization.verified.txt -->
<a id='snippet-VerifyCombinationsTests.Combination_CustomSerialization.verified.txt'></a>
```txt
{
  1, Smith St, Sydney: 1 Smith St, Sydney,
  1, Smith St, Chicago: 1 Smith St, Chicago,
  1, Wallace St, Sydney: 1 Wallace St, Sydney,
  1, Wallace St, Chicago: 1 Wallace St, Chicago,
  10, Smith St, Sydney: 10 Smith St, Sydney,
  10, Smith St, Chicago: 10 Smith St, Chicago,
  10, Wallace St, Sydney: 10 Wallace St, Sydney,
  10, Wallace St, Chicago: 10 Wallace St, Chicago
}
```
<sup><a href='/src/StaticSettingsTests/VerifyCombinationsTests.Combination_CustomSerialization.verified.txt#L1-L10' title='Snippet source file'>snippet source</a> | <a href='#snippet-VerifyCombinationsTests.Combination_CustomSerialization.verified.txt' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->
